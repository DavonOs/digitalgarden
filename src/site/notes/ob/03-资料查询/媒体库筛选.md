---
{"dg-publish":true,"dg-permalink":"/media-search","permalink":"/media-search/","metatags":{"description":"","og:site_name":"DavonOs","og:title":"媒体库筛选","og:type":"article","og:url":"https://zuji.eu.org/media-search","og:image":null,"og:image:width":"200","og:image:alt":"articlecover","og:locale":"zh_cn"},"created":"2025-07-13T09:33:36.769+08:00","updated":"2025-07-13T09:49:30.236+08:00"}
---


<style>
/* 筛选按钮样式 */
.filter-btn {
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid #ddd;
  background-color: #f8f8f8;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 80px;
  text-align: center;
}

/* 激活状态 */
.filter-btn.active {
  background-color: #7b68ee;
  color: white;
  border-color: #7b68ee;
}

/* 筛选项和排序容器 */
.filter-item, .sort-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}

/* 媒体卡片网格 */
.media-gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

/* 媒体卡片 */
.media-card {
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: transform 0.3s;
  background: white;
}

.media-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* 图片容器 */
.media-img-container {
  position: relative;
  padding-top: 150%;
  overflow: hidden;
}

/* 媒体图片 */
.media-img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* 评分、类型和状态标签 */
.media-rating, .media-type-tag, .media-status-tag {
  position: absolute;
  background: rgba(0,0,0,0.7);
  color: white;
}

.media-rating {
  bottom: 0;
  left: 0;
  right: 0;
  padding: 5px;
  text-align: center;
}

.media-type-tag, .media-status-tag {
  top: 10px;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.media-type-tag {
  left: 10px;
}

.media-status-tag {
  right: 10px;
  cursor: pointer;
}

/* 信息区域 */
.media-info {
  padding: 10px;
}

.media-title {
  font-weight: bold;
  margin-bottom: 5px;
  display: block;
  text-decoration: none;
  color: inherit;
}

.media-creator, .media-date, .media-extra-info {
  font-size: 12px;
  color: #666;
  margin-bottom: 3px;
}

/* 日期选择器 */
#custom-date-picker {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
  flex-wrap: wrap;
}

#custom-date-picker input[type="date"] {
  padding: 5px;
  border-radius: 4px;
  border: 1px solid #ddd;
}
</style>

# 📚 我的媒体库

```dataviewjs
// 初始化筛选和排序状态
const filters = {
    type: "all",
    rating: "all",
    status: "all",
    time: "all",
    customDateStart: null,
    customDateEnd: null
};

const sortState = {
    field: "score",
    direction: "desc"
};

// 获取所有媒体笔记
const mediaPages = dv.pages('"02-电影阅读"')
    .where(p => p.file)
    .array();

// 创建画廊容器
const container = this.container;

// 创建筛选按钮
function createFilterButtons() {
    const filtersContainer = document.createElement('div');
    filtersContainer.className = 'filters-container';
    container.appendChild(filtersContainer);
    
    // 获取所有媒体类型
    const allTypes = [...new Set(mediaPages.map(p => p.type).filter(Boolean))];
    
    // 类型筛选
    const typeRow = document.createElement('div');
    typeRow.className = 'filter-item';
    
    // 添加"全部"选项
    const allBtn = document.createElement('button');
    allBtn.className = 'filter-btn active';
    allBtn.textContent = '全部';
    allBtn.onclick = () => updateFilter('type', 'all', allBtn);
    typeRow.appendChild(allBtn);
    
    // 添加各种媒体类型按钮
    allTypes.forEach(type => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        
        // 根据类型设置图标
        let icon = '';
        if (type === 'movie') icon = '🎬';
        else if (type === 'teleplay') icon = '📺';
        else if (type === 'book') icon = '📚';
        else if (type === 'music') icon = '🎵';
        else if (type === 'game') icon = '🎮';
        
        btn.textContent = `${icon} ${type}`;
        btn.onclick = () => updateFilter('type', type, btn);
        typeRow.appendChild(btn);
    });
    
    filtersContainer.appendChild(typeRow);
    
    // 评分筛选
    const ratingRow = document.createElement('div');
    ratingRow.className = 'filter-item';
    
    const ratingOptions = [
        {name: '全部', value: 'all'},
        {name: '⭐⭐⭐⭐⭐', value: '5'},
        {name: '⭐⭐⭐⭐', value: '4'},
        {name: '⭐⭐⭐', value: '3'},
        {name: '⭐⭐', value: '2'},
        {name: '⭐', value: '1'}
    ];
    
    ratingOptions.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (index === 0 ? ' active' : '');
        btn.textContent = option.name;
        btn.onclick = () => updateFilter('rating', option.value, btn);
        ratingRow.appendChild(btn);
    });
    
    filtersContainer.appendChild(ratingRow);
    
    // 状态筛选
    const statusRow = document.createElement('div');
    statusRow.className = 'filter-item';
    
    const statusOptions = [
        {name: '全部', value: 'all'},
        {name: '已完成', value: 'true'},
        {name: '未完成', value: 'false'}
    ];
    
    statusOptions.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (index === 0 ? ' active' : '');
        btn.textContent = option.name;
        btn.onclick = () => updateFilter('status', option.value, btn);
        statusRow.appendChild(btn);
    });
    
    filtersContainer.appendChild(statusRow);
    
    // 时间筛选
    const timeRow = document.createElement('div');
    timeRow.className = 'filter-item';
    
    const timeOptions = [
        {name: '全部', value: 'all'},
        {name: '最近一周', value: 'week'},
        {name: '最近一月', value: 'month'},
        {name: '最近一年', value: 'year'},
        {name: '自定义范围', value: 'custom'}
    ];
    
    timeOptions.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (index === 0 ? ' active' : '');
        btn.textContent = option.name;
        btn.onclick = () => {
            updateFilter('time', option.value, btn);
            
            if (option.value === 'custom') {
                showDatePicker();
            } else {
                hideDatePicker();
            }
        };
        timeRow.appendChild(btn);
    });
    
    filtersContainer.appendChild(timeRow);
    
    // 创建排序控件
    createSortControls(filtersContainer);
}

// 创建排序控件
function createSortControls(parentContainer) {
    const sortContainer = document.createElement('div');
    sortContainer.className = 'sort-container';
    
    const sortLabel = document.createElement('span');
    sortLabel.textContent = '排序方式:';
    sortLabel.style.marginRight = '10px';
    sortContainer.appendChild(sortLabel);
    
    // 排序选项
    const sortOptions = [
        { name: '评分', field: 'score' },
        { name: '标题', field: 'title' },
        { name: '发布日期', field: 'datePublished' },
        { name: '创建时间', field: 'ctime' }
    ];
    
    sortOptions.forEach(option => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (sortState.field === option.field ? ' active' : '');
        btn.textContent = option.name;
        
        if (sortState.field === option.field) {
            btn.textContent += sortState.direction === 'desc' ? ' ↓' : ' ↑';
        }
        
        btn.onclick = () => {
            if (sortState.field === option.field) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.field = option.field;
                sortState.direction = option.field === 'score' ? 'desc' : 'asc';
            }
            
            renderGallery();
        };
        
        sortContainer.appendChild(btn);
    });
    
    parentContainer.appendChild(sortContainer);
}

// 更新筛选条件
function updateFilter(filterType, value, clickedBtn) {
    filters[filterType] = value;
    
    const parent = clickedBtn.parentElement;
    parent.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    clickedBtn.classList.add('active');
    
    renderGallery();
}

// 显示日期选择器
function showDatePicker() {
    let datePicker = document.getElementById('custom-date-picker');
    
    if (!datePicker) {
        datePicker = document.createElement('div');
        datePicker.id = 'custom-date-picker';
        
        const startLabel = document.createElement('span');
        startLabel.textContent = '开始日期:';
        datePicker.appendChild(startLabel);
        
        const startDate = document.createElement('input');
        startDate.type = 'date';
        startDate.id = 'start-date';
        startDate.value = filters.customDateStart || '';
        datePicker.appendChild(startDate);
        
        const endLabel = document.createElement('span');
        endLabel.textContent = '结束日期:';
        endLabel.style.marginLeft = '10px';
        datePicker.appendChild(endLabel);
        
        const endDate = document.createElement('input');
        endDate.type = 'date';
        endDate.id = 'end-date';
        endDate.value = filters.customDateEnd || '';
        datePicker.appendChild(endDate);
        
        const applyBtn = document.createElement('button');
        applyBtn.textContent = '应用';
        applyBtn.className = 'filter-btn';
        applyBtn.style.marginLeft = '10px';
        applyBtn.onclick = () => {
            filters.customDateStart = startDate.value;
            filters.customDateEnd = endDate.value;
            renderGallery();
        };
        datePicker.appendChild(applyBtn);
        
        container.querySelector('.filters-container').appendChild(datePicker);
    } else {
        datePicker.style.display = 'flex';
    }
}

// 隐藏日期选择器
function hideDatePicker() {
    const datePicker = document.getElementById('custom-date-picker');
    if (datePicker) {
        datePicker.style.display = 'none';
    }
}

// 渲染画廊
function renderGallery() {
    // 清除旧内容，保留筛选器
    const filtersContainer = container.querySelector('.filters-container');
    container.innerHTML = '';
    container.appendChild(filtersContainer);
    
    // 如果需要显示日期选择器
    if (filters.time === 'custom') {
        showDatePicker();
    }
    
    // 筛选数据
    let filteredPages = [...mediaPages];
    
    // 类型筛选
    if (filters.type !== "all") {
        filteredPages = filteredPages.filter(p => p.type === filters.type);
    }
    
    // 评分筛选
    if (filters.rating !== "all") {
        const targetRating = parseInt(filters.rating);
        filteredPages = filteredPages.filter(p => {
            const score = typeof p.score === 'number' ? p.score : parseFloat(p.score || 0);
            if (targetRating === 5) return score >= 9;
            if (targetRating === 4) return score >= 7 && score < 9;
            if (targetRating === 3) return score >= 5 && score < 7;
            if (targetRating === 2) return score >= 3 && score < 5;
            if (targetRating === 1) return score > 0 && score < 3;
            return false;
        });
    }
    
    // 状态筛选
    if (filters.status !== "all") {
        filteredPages = filteredPages.filter(p => p.status == (filters.status === "true"));
    }
    
    // 时间筛选
    if (filters.time !== "all") {
        const now = new Date();
        let cutoffDate;
        
        if (filters.time === "week") {
            cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        } else if (filters.time === "month") {
            cutoffDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        } else if (filters.time === "year") {
            cutoffDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
        }
        
        if (cutoffDate) {
            filteredPages = filteredPages.filter(p => {
                if (p.file && p.file.ctime) {
                    return new Date(p.file.ctime) >= cutoffDate;
                }
                return false;
            });
        } else if (filters.time === "custom" && filters.customDateStart) {
            try {
                const startDate = new Date(filters.customDateStart);
                startDate.setHours(0, 0, 0, 0);
                
                let endDate;
                if (filters.customDateEnd) {
                    endDate = new Date(filters.customDateEnd);
                    endDate.setHours(23, 59, 59, 999);
                } else {
                    endDate = new Date();
                    endDate.setHours(23, 59, 59, 999);
                }
                
                if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                    filteredPages = filteredPages.filter(p => {
                        if (p.file && p.file.ctime) {
                            const ctime = new Date(p.file.ctime);
                            return ctime >= startDate && ctime <= endDate;
                        }
                        return false;
                    });
                }
            } catch (e) {
                console.error("日期处理错误:", e);
            }
        }
    }
    
    // 排序数据
    filteredPages.sort((a, b) => {
        let valueA, valueB;
        
        // 根据排序字段获取值
        if (sortState.field === 'score') {
            valueA = typeof a.score === 'number' ? a.score : parseFloat(a.score || 0);
            valueB = typeof b.score === 'number' ? b.score : parseFloat(b.score || 0);
        } 
        else if (sortState.field === 'title') {
            valueA = (a.title || '').toString().toLowerCase();
            valueB = (b.title || '').toString().toLowerCase();
        }
        else if (sortState.field === 'datePublished') {
            valueA = a.datePublished ? new Date(a.datePublished) : new Date(0);
            valueB = b.datePublished ? new Date(b.datePublished) : new Date(0);
            
            // 如果日期无效，尝试作为年份处理
            if (isNaN(valueA.getTime()) && !isNaN(parseInt(a.datePublished))) {
                valueA = parseInt(a.datePublished);
            }
            if (isNaN(valueB.getTime()) && !isNaN(parseInt(b.datePublished))) {
                valueB = parseInt(b.datePublished);
            }
            
            // 如果仍然无效，放到最后
            if (isNaN(valueA.getTime()) && typeof valueA !== 'number') valueA = 0;
            if (isNaN(valueB.getTime()) && typeof valueB !== 'number') valueB = 0;
        }
        else if (sortState.field === 'ctime') {
            valueA = a.file && a.file.ctime ? new Date(a.file.ctime) : new Date(0);
            valueB = b.file && b.file.ctime ? new Date(b.file.ctime) : new Date(0);
        }
        
        // 根据排序方向比较
        if (sortState.direction === 'asc') {
            if (valueA < valueB) return -1;
            if (valueA > valueB) return 1;
            return 0;
        } else {
            if (valueA > valueB) return -1;
            if (valueA < valueB) return 1;
            return 0;
        }
    });
    
    // 显示结果计数
    const countDiv = document.createElement('div');
    countDiv.style.margin = '15px 0';
    countDiv.style.fontWeight = 'bold';
    countDiv.textContent = `找到 ${filteredPages.length} 个结果`;
    container.appendChild(countDiv);
    
    // 创建画廊网格
    const gallery = document.createElement('div');
    gallery.className = 'media-gallery-grid';
    container.appendChild(gallery);
    
    // 渲染媒体卡片
    filteredPages.forEach(page => {
        const card = document.createElement('div');
        card.className = 'media-card';
        
        // 图片容器
        const imgContainer = document.createElement('div');
        imgContainer.className = 'media-img-container';
        
        // 封面图片
        const img = document.createElement('img');
        img.className = 'media-img';
        img.loading = 'lazy';
        img.alt = page.title || '媒体';
        
        // 处理图片URL
        let imageFound = false;
        const possibleImageProps = ['image', 'cover', 'poster', 'thumbnail', 'gamecover', 'coverImage'];
        
        for (const prop of possibleImageProps) {
            if (page[prop] && typeof page[prop] === 'string') {
                imageFound = true;
                const imgSrc = page[prop];
                
                if (imgSrc.startsWith('http') || imgSrc.startsWith('data:')) {
                    img.src = imgSrc;
                    break;
                } else if (imgSrc.includes('[[') || imgSrc.includes('![[')) {
                    const cleanPath = imgSrc.replace(/[!\[\]]/g, '').split('|')[0].trim();
                    try {
                        img.src = app.vault.adapter.getResourcePath(cleanPath);
                        break;
                    } catch (e) {
                        imageFound = false;
                    }
                } else {
                    try {
                        img.src = app.vault.adapter.getResourcePath(imgSrc);
                        break;
                    } catch (e) {
                        img.src = imgSrc;
                        break;
                    }
                }
            }
        }
        
        // 设置默认图片
        if (!imageFound) {
            const type = page.type || 'unknown';
            if (type === 'movie') {
                img.src = `https://via.placeholder.com/150x200/6b4a67/ffffff?text=🎬+电影`;
            } else if (type === 'teleplay') {
                img.src = `https://via.placeholder.com/150x200/4a5e67/ffffff?text=📺+剧集`;
            } else if (type === 'book') {
                img.src = `https://via.placeholder.com/150x200/674a4a/ffffff?text=📚+书籍`;
            } else if (type === 'music') {
                img.src = `https://via.placeholder.com/150x200/67674a/ffffff?text=🎵+音乐`;
            } else if (type === 'game') {
                img.src = `https://via.placeholder.com/150x200/4a6741/ffffff?text=🎮+游戏`;
            } else {
                img.src = `https://via.placeholder.com/150x200/4a4a4a/ffffff?text=📄+${type}`;
            }
        }
        
        // 错误处理
        img.onerror = function() {
            const type = page.type || 'unknown';
            if (type === 'movie') {
                this.src = `https://via.placeholder.com/150x200/6b4a67/ffffff?text=🎬+电影`;
            } else if (type === 'teleplay') {
                this.src = `https://via.placeholder.com/150x200/4a5e67/ffffff?text=📺+剧集`;
            } else if (type === 'book') {
                this.src = `https://via.placeholder.com/150x200/674a4a/ffffff?text=📚+书籍`;
            } else if (type === 'music') {
                this.src = `https://via.placeholder.com/150x200/67674a/ffffff?text=🎵+音乐`;
            } else if (type === 'game') {
                this.src = `https://via.placeholder.com/150x200/4a6741/ffffff?text=🎮+游戏`;
            } else {
                this.src = `https://via.placeholder.com/150x200/4a4a4a/ffffff?text=📄+${type}`;
            }
            this.onerror = null;
        };
        
        imgContainer.appendChild(img);
        
        // 评分星星
        const ratingDiv = document.createElement('div');
        ratingDiv.className = 'media-rating';
        const score = typeof page.score === 'number' ? page.score : parseFloat(page.score || 0);
        
        let stars = '';
        if (score >= 9) stars = '⭐⭐⭐⭐⭐';
        else if (score >= 7) stars = '⭐⭐⭐⭐';
        else if (score >= 5) stars = '⭐⭐⭐';
        else if (score >= 3) stars = '⭐⭐';
        else if (score > 0) stars = '⭐';
        else stars = '未评分';
        
        ratingDiv.innerHTML = stars;
        imgContainer.appendChild(ratingDiv);
        
        // 类型标签
        const typeTag = document.createElement('div');
        typeTag.className = 'media-type-tag';
        
        if (page.type === 'movie') {
            typeTag.textContent = '🎬';
            typeTag.title = '电影';
        } else if (page.type === 'teleplay') {
            typeTag.textContent = '📺';
            typeTag.title = '电视剧';
        } else if (page.type === 'book') {
            typeTag.textContent = '📚';
            typeTag.title = '书籍';
        } else if (page.type === 'music') {
            typeTag.textContent = '🎵';
            typeTag.title = '音乐';
        } else if (page.type === 'game') {
            typeTag.textContent = '🎮';
            typeTag.title = '游戏';
        } else {
            typeTag.textContent = '📄';
            typeTag.title = page.type || '未知';
        }
        
        imgContainer.appendChild(typeTag);
        
        // 状态标签
        const statusTag = document.createElement('div');
        statusTag.className = 'media-status-tag';
        statusTag.textContent = page.status ? '✓' : '◯';
        statusTag.title = page.status ? '已完成 (点击切换)' : '未完成 (点击切换)';
        
        // 添加点击事件来切换状态
        statusTag.addEventListener('click', async (event) => {
            event.stopPropagation();
            
            try {
                // 获取文件内容
                const filePath = page.file.path;
                const fileContent = await app.vault.adapter.read(filePath);
                
                // 更新状态值
                const newStatus = !page.status;
                
                // 准备替换的内容
                let newContent;
                
                if (fileContent.startsWith('---')) {
                    const yamlEndIndex = fileContent.indexOf('---', 3);
                    if (yamlEndIndex > 0) {
                        const yamlContent = fileContent.substring(0, yamlEndIndex);
                        
                        if (yamlContent.includes('status:')) {
                            newContent = fileContent.replace(
                                /status:\s*(true|false)/i,
                                `status: ${newStatus}`
                            );
                        } else {
                            newContent = fileContent.replace(
                                '---',
                                `status: ${newStatus}\n---`
                            );
                        }
                    } else {
                        newContent = `---\nstatus: ${newStatus}\n---\n\n${fileContent}`;
                    }
                } else {
                    newContent = `---\nstatus: ${newStatus}\n---\n\n${fileContent}`;
                }
                
                // 写入文件
                await app.vault.adapter.write(filePath, newContent);
                
                // 更新UI
                statusTag.textContent = newStatus ? '✓' : '◯';
                statusTag.title = newStatus ? '已完成 (点击切换)' : '未完成 (点击切换)';
                
                // 更新页面对象的状态
                page.status = newStatus;
                
                // 如果当前有状态筛选，可能需要重新渲染
                if (filters.status !== 'all') {
                    renderGallery();
                }
                
                // 显示成功提示
                const notification = document.createElement('div');
                notification.textContent = `已将 "${page.title}" 标记为${newStatus ? '已完成' : '未完成'}`;
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.right = '20px';
                notification.style.padding = '10px 15px';
                notification.style.backgroundColor = '#4CAF50';
                notification.style.color = 'white';
                notification.style.borderRadius = '4px';
                notification.style.zIndex = '1000';
                notification.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                document.body.appendChild(notification);
                
                // 2秒后移除提示
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 2000);
                
            } catch (error) {
                console.error('更新状态失败:', error);
                
                // 显示错误提示
                const errorNotification = document.createElement('div');
                errorNotification.textContent = `更新状态失败: ${error.message}`;
                errorNotification.style.position = 'fixed';
                errorNotification.style.bottom = '20px';
                errorNotification.style.right = '20px';
                errorNotification.style.padding = '10px 15px';
                errorNotification.style.backgroundColor = '#F44336';
                errorNotification.style.color = 'white';
                errorNotification.style.borderRadius = '4px';
                errorNotification.style.zIndex = '1000';
                document.body.appendChild(errorNotification);
                
                setTimeout(() => {
                    document.body.removeChild(errorNotification);
                }, 3000);
            }
        });
        
        imgContainer.appendChild(statusTag);
        card.appendChild(imgContainer);
        
        // 信息区域
        const infoDiv = document.createElement('div');
        infoDiv.className = 'media-info';
        
        // 标题链接
        const title = document.createElement('a');
        title.className = 'media-title';
        title.href = page.file.path;
        title.dataset.href = page.file.path;
        title.textContent = typeof page.title === 'object' ? 
            (page.title.toString ? page.title.toString() : '未命名') : 
            (page.title || '未命名');
        title.addEventListener('click', (event) => {
            event.preventDefault();
            if (app && app.workspace) {
                app.workspace.openLinkText(page.file.path, '', false);
            }
        });
        infoDiv.appendChild(title);
        
        // 添加创作者信息（导演、作者、演员等）
        try {
            if (page.type === 'movie' && page.director) {
                const creator = document.createElement('div');
                creator.className = 'media-creator';
                creator.textContent = `导演: ${typeof page.director === 'object' ? 
                    (page.director.toString ? page.director.toString() : '未知') : page.director}`;
                infoDiv.appendChild(creator);
            } else if ((page.type === 'movie' || page.type === 'teleplay') && page.actor) {
                const creator = document.createElement('div');
                creator.className = 'media-creator';
                creator.textContent = `主演: ${typeof page.actor === 'object' ? 
                    (page.actor.toString ? page.actor.toString() : '未知') : page.actor}`;
                infoDiv.appendChild(creator);
            } else if (page.type === 'book' && page.author) {
                const creator = document.createElement('div');
                creator.className = 'media-creator';
                creator.textContent = `作者: ${typeof page.author === 'object' ? 
                    (page.author.toString ? page.author.toString() : '未知') : page.author}`;
                infoDiv.appendChild(creator);
            } else if (page.type === 'game' && page.developer) {
                const creator = document.createElement('div');
                creator.className = 'media-creator';
                creator.textContent = `开发商: ${typeof page.developer === 'object' ? 
                    (page.developer.toString ? page.developer.toString() : '未知') : page.developer}`;
                infoDiv.appendChild(creator);
            }
        } catch (e) {
            console.error('创作者信息处理错误:', e);
        }
        
        // 添加发行日期信息（精确到月份）
        try {
            if (page.datePublished || page.releaseDate) {
                const date = document.createElement('div');
                date.className = 'media-date';
                
                // 使用releaseDate作为备选
                let dateValue = page.datePublished || page.releaseDate;
                let dateText = dateValue.toString();
                
                // 格式化日期，精确到月份
                if (dateText.includes('-')) {
                    const parts = dateText.split('-');
                    if (parts.length >= 2) {
                        dateText = parts[0] + '年' + parts[1] + '月';
                    }
                } else if (!isNaN(dateText)) {
                    dateText = dateText + '年';
                }
                
                date.textContent = dateText;
                infoDiv.appendChild(date);
            }
        } catch (e) {
            console.error('日期处理错误:', e);
        }
        
        // 添加额外信息（书籍页数、电影时长等）
        try {
            if (page.type === 'book' && page.pages) {
                const extraInfo = document.createElement('div');
                extraInfo.className = 'media-extra-info';
                extraInfo.textContent = `${page.pages}页`;
                infoDiv.appendChild(extraInfo);
            } else if (page.type === 'movie' && page.time) {
                const extraInfo = document.createElement('div');
                extraInfo.className = 'media-extra-info';
                extraInfo.textContent = `${page.time}分钟`;
                infoDiv.appendChild(extraInfo);
            } else if (page.type === 'teleplay' && page.episode) {
                const extraInfo = document.createElement('div');
                extraInfo.className = 'media-extra-info';
                extraInfo.textContent = `${page.episode}集`;
                infoDiv.appendChild(extraInfo);
            } else if (page.type === 'game' && (page.platform || page.playTime)) {
                if (page.platform) {
                    const platformInfo = document.createElement('div');
                    platformInfo.className = 'media-extra-info';
                    platformInfo.textContent = `平台: ${page.platform}`;
                    infoDiv.appendChild(platformInfo);
                }
                if (page.playTime) {
                    const timeInfo = document.createElement('div');
                    timeInfo.className = 'media-extra-info';
                    timeInfo.textContent = `游戏时长: ${page.playTime}`;
                    infoDiv.appendChild(timeInfo);
                }
            }
        } catch (e) {
            console.error('额外信息处理错误:', e);
        }
        
        card.appendChild(infoDiv);
        gallery.appendChild(card);
    });
    
    if (filteredPages.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = '没有找到符合条件的结果';
        container.appendChild(noResults);
    }
}

// 排序页面 - 修复排序函数
function sortPages(pages) {
    // 转换为数组以便排序
    const pagesArray = [...pages];
    
    return pagesArray.sort((a, b) => {
        let valueA, valueB;
        
        // 根据排序字段获取值
        if (sortState.field === 'score') {
            valueA = typeof a.score === 'number' ? a.score : parseFloat(a.score || 0);
            valueB = typeof b.score === 'number' ? b.score : parseFloat(b.score || 0);
        } 
        else if (sortState.field === 'title') {
            valueA = (a.title || '').toString().toLowerCase();
            valueB = (b.title || '').toString().toLowerCase();
        }
        else if (sortState.field === 'datePublished') {
            // 处理日期发布
            valueA = a.datePublished ? new Date(a.datePublished) : new Date(0);
            valueB = b.datePublished ? new Date(b.datePublished) : new Date(0);
            
            // 如果日期无效，尝试作为年份处理
            if (isNaN(valueA.getTime()) && !isNaN(parseInt(a.datePublished))) {
                valueA = parseInt(a.datePublished);
            }
            if (isNaN(valueB.getTime()) && !isNaN(parseInt(b.datePublished))) {
                valueB = parseInt(b.datePublished);
            }
            
            // 如果仍然无效，放到最后
            if (isNaN(valueA.getTime()) && typeof valueA !== 'number') valueA = 0;
            if (isNaN(valueB.getTime()) && typeof valueB !== 'number') valueB = 0;
        }
        else if (sortState.field === 'ctime') {
            valueA = a.file && a.file.ctime ? new Date(a.file.ctime) : new Date(0);
            valueB = b.file && b.file.ctime ? new Date(b.file.ctime) : new Date(0);
        }
        
        // 根据排序方向比较
        if (sortState.direction === 'asc') {
            if (valueA < valueB) return -1;
            if (valueA > valueB) return 1;
            return 0;
        } else {
            if (valueA > valueB) return -1;
            if (valueA < valueB) return 1;
            return 0;
        }
    });
}

// 初始化函数
function init() {
    createFilterButtons();
    renderGallery();
}

// 执行初始化
init();