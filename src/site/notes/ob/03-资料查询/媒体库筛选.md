---
{"dg-publish":true,"dg-permalink":"/media-search","permalink":"/media-search/","metatags":{"description":"","og:site_name":"DavonOs","og:title":"åª’ä½“åº“ç­›é€‰","og:type":"article","og:url":"https://zuji.eu.org/media-search","og:image":null,"og:image:width":"200","og:image:alt":"articlecover","og:locale":"zh_cn"},"created":"2025-07-13T09:33:36.769+08:00","updated":"2025-07-13T09:49:30.236+08:00"}
---


<style>
/* ç­›é€‰æŒ‰é’®æ ·å¼ */
.filter-btn {
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid #ddd;
  background-color: #f8f8f8;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 80px;
  text-align: center;
}

/* æ¿€æ´»çŠ¶æ€ */
.filter-btn.active {
  background-color: #7b68ee;
  color: white;
  border-color: #7b68ee;
}

/* ç­›é€‰é¡¹å’Œæ’åºå®¹å™¨ */
.filter-item, .sort-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}

/* åª’ä½“å¡ç‰‡ç½‘æ ¼ */
.media-gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

/* åª’ä½“å¡ç‰‡ */
.media-card {
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: transform 0.3s;
  background: white;
}

.media-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* å›¾ç‰‡å®¹å™¨ */
.media-img-container {
  position: relative;
  padding-top: 150%;
  overflow: hidden;
}

/* åª’ä½“å›¾ç‰‡ */
.media-img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* è¯„åˆ†ã€ç±»å‹å’ŒçŠ¶æ€æ ‡ç­¾ */
.media-rating, .media-type-tag, .media-status-tag {
  position: absolute;
  background: rgba(0,0,0,0.7);
  color: white;
}

.media-rating {
  bottom: 0;
  left: 0;
  right: 0;
  padding: 5px;
  text-align: center;
}

.media-type-tag, .media-status-tag {
  top: 10px;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.media-type-tag {
  left: 10px;
}

.media-status-tag {
  right: 10px;
  cursor: pointer;
}

/* ä¿¡æ¯åŒºåŸŸ */
.media-info {
  padding: 10px;
}

.media-title {
  font-weight: bold;
  margin-bottom: 5px;
  display: block;
  text-decoration: none;
  color: inherit;
}

.media-creator, .media-date, .media-extra-info {
  font-size: 12px;
  color: #666;
  margin-bottom: 3px;
}

/* æ—¥æœŸé€‰æ‹©å™¨ */
#custom-date-picker {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
  flex-wrap: wrap;
}

#custom-date-picker input[type="date"] {
  padding: 5px;
  border-radius: 4px;
  border: 1px solid #ddd;
}
</style>

# ğŸ“š æˆ‘çš„åª’ä½“åº“

```dataviewjs
// åˆå§‹åŒ–ç­›é€‰å’Œæ’åºçŠ¶æ€
const filters = {
    type: "all",
    rating: "all",
    status: "all",
    time: "all",
    customDateStart: null,
    customDateEnd: null
};

const sortState = {
    field: "score",
    direction: "desc"
};

// è·å–æ‰€æœ‰åª’ä½“ç¬”è®°
const mediaPages = dv.pages('"02-ç”µå½±é˜…è¯»"')
    .where(p => p.file)
    .array();

// åˆ›å»ºç”»å»Šå®¹å™¨
const container = this.container;

// åˆ›å»ºç­›é€‰æŒ‰é’®
function createFilterButtons() {
    const filtersContainer = document.createElement('div');
    filtersContainer.className = 'filters-container';
    container.appendChild(filtersContainer);
    
    // è·å–æ‰€æœ‰åª’ä½“ç±»å‹
    const allTypes = [...new Set(mediaPages.map(p => p.type).filter(Boolean))];
    
    // ç±»å‹ç­›é€‰
    const typeRow = document.createElement('div');
    typeRow.className = 'filter-item';
    
    // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
    const allBtn = document.createElement('button');
    allBtn.className = 'filter-btn active';
    allBtn.textContent = 'å…¨éƒ¨';
    allBtn.onclick = () => updateFilter('type', 'all', allBtn);
    typeRow.appendChild(allBtn);
    
    // æ·»åŠ å„ç§åª’ä½“ç±»å‹æŒ‰é’®
    allTypes.forEach(type => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        
        // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡
        let icon = '';
        if (type === 'movie') icon = 'ğŸ¬';
        else if (type === 'teleplay') icon = 'ğŸ“º';
        else if (type === 'book') icon = 'ğŸ“š';
        else if (type === 'music') icon = 'ğŸµ';
        else if (type === 'game') icon = 'ğŸ®';
        
        btn.textContent = `${icon} ${type}`;
        btn.onclick = () => updateFilter('type', type, btn);
        typeRow.appendChild(btn);
    });
    
    filtersContainer.appendChild(typeRow);
    
    // è¯„åˆ†ç­›é€‰
    const ratingRow = document.createElement('div');
    ratingRow.className = 'filter-item';
    
    const ratingOptions = [
        {name: 'å…¨éƒ¨', value: 'all'},
        {name: 'â­â­â­â­â­', value: '5'},
        {name: 'â­â­â­â­', value: '4'},
        {name: 'â­â­â­', value: '3'},
        {name: 'â­â­', value: '2'},
        {name: 'â­', value: '1'}
    ];
    
    ratingOptions.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (index === 0 ? ' active' : '');
        btn.textContent = option.name;
        btn.onclick = () => updateFilter('rating', option.value, btn);
        ratingRow.appendChild(btn);
    });
    
    filtersContainer.appendChild(ratingRow);
    
    // çŠ¶æ€ç­›é€‰
    const statusRow = document.createElement('div');
    statusRow.className = 'filter-item';
    
    const statusOptions = [
        {name: 'å…¨éƒ¨', value: 'all'},
        {name: 'å·²å®Œæˆ', value: 'true'},
        {name: 'æœªå®Œæˆ', value: 'false'}
    ];
    
    statusOptions.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (index === 0 ? ' active' : '');
        btn.textContent = option.name;
        btn.onclick = () => updateFilter('status', option.value, btn);
        statusRow.appendChild(btn);
    });
    
    filtersContainer.appendChild(statusRow);
    
    // æ—¶é—´ç­›é€‰
    const timeRow = document.createElement('div');
    timeRow.className = 'filter-item';
    
    const timeOptions = [
        {name: 'å…¨éƒ¨', value: 'all'},
        {name: 'æœ€è¿‘ä¸€å‘¨', value: 'week'},
        {name: 'æœ€è¿‘ä¸€æœˆ', value: 'month'},
        {name: 'æœ€è¿‘ä¸€å¹´', value: 'year'},
        {name: 'è‡ªå®šä¹‰èŒƒå›´', value: 'custom'}
    ];
    
    timeOptions.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (index === 0 ? ' active' : '');
        btn.textContent = option.name;
        btn.onclick = () => {
            updateFilter('time', option.value, btn);
            
            if (option.value === 'custom') {
                showDatePicker();
            } else {
                hideDatePicker();
            }
        };
        timeRow.appendChild(btn);
    });
    
    filtersContainer.appendChild(timeRow);
    
    // åˆ›å»ºæ’åºæ§ä»¶
    createSortControls(filtersContainer);
}

// åˆ›å»ºæ’åºæ§ä»¶
function createSortControls(parentContainer) {
    const sortContainer = document.createElement('div');
    sortContainer.className = 'sort-container';
    
    const sortLabel = document.createElement('span');
    sortLabel.textContent = 'æ’åºæ–¹å¼:';
    sortLabel.style.marginRight = '10px';
    sortContainer.appendChild(sortLabel);
    
    // æ’åºé€‰é¡¹
    const sortOptions = [
        { name: 'è¯„åˆ†', field: 'score' },
        { name: 'æ ‡é¢˜', field: 'title' },
        { name: 'å‘å¸ƒæ—¥æœŸ', field: 'datePublished' },
        { name: 'åˆ›å»ºæ—¶é—´', field: 'ctime' }
    ];
    
    sortOptions.forEach(option => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (sortState.field === option.field ? ' active' : '');
        btn.textContent = option.name;
        
        if (sortState.field === option.field) {
            btn.textContent += sortState.direction === 'desc' ? ' â†“' : ' â†‘';
        }
        
        btn.onclick = () => {
            if (sortState.field === option.field) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.field = option.field;
                sortState.direction = option.field === 'score' ? 'desc' : 'asc';
            }
            
            renderGallery();
        };
        
        sortContainer.appendChild(btn);
    });
    
    parentContainer.appendChild(sortContainer);
}

// æ›´æ–°ç­›é€‰æ¡ä»¶
function updateFilter(filterType, value, clickedBtn) {
    filters[filterType] = value;
    
    const parent = clickedBtn.parentElement;
    parent.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    clickedBtn.classList.add('active');
    
    renderGallery();
}

// æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
function showDatePicker() {
    let datePicker = document.getElementById('custom-date-picker');
    
    if (!datePicker) {
        datePicker = document.createElement('div');
        datePicker.id = 'custom-date-picker';
        
        const startLabel = document.createElement('span');
        startLabel.textContent = 'å¼€å§‹æ—¥æœŸ:';
        datePicker.appendChild(startLabel);
        
        const startDate = document.createElement('input');
        startDate.type = 'date';
        startDate.id = 'start-date';
        startDate.value = filters.customDateStart || '';
        datePicker.appendChild(startDate);
        
        const endLabel = document.createElement('span');
        endLabel.textContent = 'ç»“æŸæ—¥æœŸ:';
        endLabel.style.marginLeft = '10px';
        datePicker.appendChild(endLabel);
        
        const endDate = document.createElement('input');
        endDate.type = 'date';
        endDate.id = 'end-date';
        endDate.value = filters.customDateEnd || '';
        datePicker.appendChild(endDate);
        
        const applyBtn = document.createElement('button');
        applyBtn.textContent = 'åº”ç”¨';
        applyBtn.className = 'filter-btn';
        applyBtn.style.marginLeft = '10px';
        applyBtn.onclick = () => {
            filters.customDateStart = startDate.value;
            filters.customDateEnd = endDate.value;
            renderGallery();
        };
        datePicker.appendChild(applyBtn);
        
        container.querySelector('.filters-container').appendChild(datePicker);
    } else {
        datePicker.style.display = 'flex';
    }
}

// éšè—æ—¥æœŸé€‰æ‹©å™¨
function hideDatePicker() {
    const datePicker = document.getElementById('custom-date-picker');
    if (datePicker) {
        datePicker.style.display = 'none';
    }
}

// æ¸²æŸ“ç”»å»Š
function renderGallery() {
    // æ¸…é™¤æ—§å†…å®¹ï¼Œä¿ç•™ç­›é€‰å™¨
    const filtersContainer = container.querySelector('.filters-container');
    container.innerHTML = '';
    container.appendChild(filtersContainer);
    
    // å¦‚æœéœ€è¦æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
    if (filters.time === 'custom') {
        showDatePicker();
    }
    
    // ç­›é€‰æ•°æ®
    let filteredPages = [...mediaPages];
    
    // ç±»å‹ç­›é€‰
    if (filters.type !== "all") {
        filteredPages = filteredPages.filter(p => p.type === filters.type);
    }
    
    // è¯„åˆ†ç­›é€‰
    if (filters.rating !== "all") {
        const targetRating = parseInt(filters.rating);
        filteredPages = filteredPages.filter(p => {
            const score = typeof p.score === 'number' ? p.score : parseFloat(p.score || 0);
            if (targetRating === 5) return score >= 9;
            if (targetRating === 4) return score >= 7 && score < 9;
            if (targetRating === 3) return score >= 5 && score < 7;
            if (targetRating === 2) return score >= 3 && score < 5;
            if (targetRating === 1) return score > 0 && score < 3;
            return false;
        });
    }
    
    // çŠ¶æ€ç­›é€‰
    if (filters.status !== "all") {
        filteredPages = filteredPages.filter(p => p.status == (filters.status === "true"));
    }
    
    // æ—¶é—´ç­›é€‰
    if (filters.time !== "all") {
        const now = new Date();
        let cutoffDate;
        
        if (filters.time === "week") {
            cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        } else if (filters.time === "month") {
            cutoffDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        } else if (filters.time === "year") {
            cutoffDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
        }
        
        if (cutoffDate) {
            filteredPages = filteredPages.filter(p => {
                if (p.file && p.file.ctime) {
                    return new Date(p.file.ctime) >= cutoffDate;
                }
                return false;
            });
        } else if (filters.time === "custom" && filters.customDateStart) {
            try {
                const startDate = new Date(filters.customDateStart);
                startDate.setHours(0, 0, 0, 0);
                
                let endDate;
                if (filters.customDateEnd) {
                    endDate = new Date(filters.customDateEnd);
                    endDate.setHours(23, 59, 59, 999);
                } else {
                    endDate = new Date();
                    endDate.setHours(23, 59, 59, 999);
                }
                
                if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                    filteredPages = filteredPages.filter(p => {
                        if (p.file && p.file.ctime) {
                            const ctime = new Date(p.file.ctime);
                            return ctime >= startDate && ctime <= endDate;
                        }
                        return false;
                    });
                }
            } catch (e) {
                console.error("æ—¥æœŸå¤„ç†é”™è¯¯:", e);
            }
        }
    }
    
    // æ’åºæ•°æ®
    filteredPages.sort((a, b) => {
        let valueA, valueB;
        
        // æ ¹æ®æ’åºå­—æ®µè·å–å€¼
        if (sortState.field === 'score') {
            valueA = typeof a.score === 'number' ? a.score : parseFloat(a.score || 0);
            valueB = typeof b.score === 'number' ? b.score : parseFloat(b.score || 0);
        } 
        else if (sortState.field === 'title') {
            valueA = (a.title || '').toString().toLowerCase();
            valueB = (b.title || '').toString().toLowerCase();
        }
        else if (sortState.field === 'datePublished') {
            valueA = a.datePublished ? new Date(a.datePublished) : new Date(0);
            valueB = b.datePublished ? new Date(b.datePublished) : new Date(0);
            
            // å¦‚æœæ—¥æœŸæ— æ•ˆï¼Œå°è¯•ä½œä¸ºå¹´ä»½å¤„ç†
            if (isNaN(valueA.getTime()) && !isNaN(parseInt(a.datePublished))) {
                valueA = parseInt(a.datePublished);
            }
            if (isNaN(valueB.getTime()) && !isNaN(parseInt(b.datePublished))) {
                valueB = parseInt(b.datePublished);
            }
            
            // å¦‚æœä»ç„¶æ— æ•ˆï¼Œæ”¾åˆ°æœ€å
            if (isNaN(valueA.getTime()) && typeof valueA !== 'number') valueA = 0;
            if (isNaN(valueB.getTime()) && typeof valueB !== 'number') valueB = 0;
        }
        else if (sortState.field === 'ctime') {
            valueA = a.file && a.file.ctime ? new Date(a.file.ctime) : new Date(0);
            valueB = b.file && b.file.ctime ? new Date(b.file.ctime) : new Date(0);
        }
        
        // æ ¹æ®æ’åºæ–¹å‘æ¯”è¾ƒ
        if (sortState.direction === 'asc') {
            if (valueA < valueB) return -1;
            if (valueA > valueB) return 1;
            return 0;
        } else {
            if (valueA > valueB) return -1;
            if (valueA < valueB) return 1;
            return 0;
        }
    });
    
    // æ˜¾ç¤ºç»“æœè®¡æ•°
    const countDiv = document.createElement('div');
    countDiv.style.margin = '15px 0';
    countDiv.style.fontWeight = 'bold';
    countDiv.textContent = `æ‰¾åˆ° ${filteredPages.length} ä¸ªç»“æœ`;
    container.appendChild(countDiv);
    
    // åˆ›å»ºç”»å»Šç½‘æ ¼
    const gallery = document.createElement('div');
    gallery.className = 'media-gallery-grid';
    container.appendChild(gallery);
    
    // æ¸²æŸ“åª’ä½“å¡ç‰‡
    filteredPages.forEach(page => {
        const card = document.createElement('div');
        card.className = 'media-card';
        
        // å›¾ç‰‡å®¹å™¨
        const imgContainer = document.createElement('div');
        imgContainer.className = 'media-img-container';
        
        // å°é¢å›¾ç‰‡
        const img = document.createElement('img');
        img.className = 'media-img';
        img.loading = 'lazy';
        img.alt = page.title || 'åª’ä½“';
        
        // å¤„ç†å›¾ç‰‡URL
        let imageFound = false;
        const possibleImageProps = ['image', 'cover', 'poster', 'thumbnail', 'gamecover', 'coverImage'];
        
        for (const prop of possibleImageProps) {
            if (page[prop] && typeof page[prop] === 'string') {
                imageFound = true;
                const imgSrc = page[prop];
                
                if (imgSrc.startsWith('http') || imgSrc.startsWith('data:')) {
                    img.src = imgSrc;
                    break;
                } else if (imgSrc.includes('[[') || imgSrc.includes('![[')) {
                    const cleanPath = imgSrc.replace(/[!\[\]]/g, '').split('|')[0].trim();
                    try {
                        img.src = app.vault.adapter.getResourcePath(cleanPath);
                        break;
                    } catch (e) {
                        imageFound = false;
                    }
                } else {
                    try {
                        img.src = app.vault.adapter.getResourcePath(imgSrc);
                        break;
                    } catch (e) {
                        img.src = imgSrc;
                        break;
                    }
                }
            }
        }
        
        // è®¾ç½®é»˜è®¤å›¾ç‰‡
        if (!imageFound) {
            const type = page.type || 'unknown';
            if (type === 'movie') {
                img.src = `https://via.placeholder.com/150x200/6b4a67/ffffff?text=ğŸ¬+ç”µå½±`;
            } else if (type === 'teleplay') {
                img.src = `https://via.placeholder.com/150x200/4a5e67/ffffff?text=ğŸ“º+å‰§é›†`;
            } else if (type === 'book') {
                img.src = `https://via.placeholder.com/150x200/674a4a/ffffff?text=ğŸ“š+ä¹¦ç±`;
            } else if (type === 'music') {
                img.src = `https://via.placeholder.com/150x200/67674a/ffffff?text=ğŸµ+éŸ³ä¹`;
            } else if (type === 'game') {
                img.src = `https://via.placeholder.com/150x200/4a6741/ffffff?text=ğŸ®+æ¸¸æˆ`;
            } else {
                img.src = `https://via.placeholder.com/150x200/4a4a4a/ffffff?text=ğŸ“„+${type}`;
            }
        }
        
        // é”™è¯¯å¤„ç†
        img.onerror = function() {
            const type = page.type || 'unknown';
            if (type === 'movie') {
                this.src = `https://via.placeholder.com/150x200/6b4a67/ffffff?text=ğŸ¬+ç”µå½±`;
            } else if (type === 'teleplay') {
                this.src = `https://via.placeholder.com/150x200/4a5e67/ffffff?text=ğŸ“º+å‰§é›†`;
            } else if (type === 'book') {
                this.src = `https://via.placeholder.com/150x200/674a4a/ffffff?text=ğŸ“š+ä¹¦ç±`;
            } else if (type === 'music') {
                this.src = `https://via.placeholder.com/150x200/67674a/ffffff?text=ğŸµ+éŸ³ä¹`;
            } else if (type === 'game') {
                this.src = `https://via.placeholder.com/150x200/4a6741/ffffff?text=ğŸ®+æ¸¸æˆ`;
            } else {
                this.src = `https://via.placeholder.com/150x200/4a4a4a/ffffff?text=ğŸ“„+${type}`;
            }
            this.onerror = null;
        };
        
        imgContainer.appendChild(img);
        
        // è¯„åˆ†æ˜Ÿæ˜Ÿ
        const ratingDiv = document.createElement('div');
        ratingDiv.className = 'media-rating';
        const score = typeof page.score === 'number' ? page.score : parseFloat(page.score || 0);
        
        let stars = '';
        if (score >= 9) stars = 'â­â­â­â­â­';
        else if (score >= 7) stars = 'â­â­â­â­';
        else if (score >= 5) stars = 'â­â­â­';
        else if (score >= 3) stars = 'â­â­';
        else if (score > 0) stars = 'â­';
        else stars = 'æœªè¯„åˆ†';
        
        ratingDiv.innerHTML = stars;
        imgContainer.appendChild(ratingDiv);
        
        // ç±»å‹æ ‡ç­¾
        const typeTag = document.createElement('div');
        typeTag.className = 'media-type-tag';
        
        if (page.type === 'movie') {
            typeTag.textContent = 'ğŸ¬';
            typeTag.title = 'ç”µå½±';
        } else if (page.type === 'teleplay') {
            typeTag.textContent = 'ğŸ“º';
            typeTag.title = 'ç”µè§†å‰§';
        } else if (page.type === 'book') {
            typeTag.textContent = 'ğŸ“š';
            typeTag.title = 'ä¹¦ç±';
        } else if (page.type === 'music') {
            typeTag.textContent = 'ğŸµ';
            typeTag.title = 'éŸ³ä¹';
        } else if (page.type === 'game') {
            typeTag.textContent = 'ğŸ®';
            typeTag.title = 'æ¸¸æˆ';
        } else {
            typeTag.textContent = 'ğŸ“„';
            typeTag.title = page.type || 'æœªçŸ¥';
        }
        
        imgContainer.appendChild(typeTag);
        
        // çŠ¶æ€æ ‡ç­¾
        const statusTag = document.createElement('div');
        statusTag.className = 'media-status-tag';
        statusTag.textContent = page.status ? 'âœ“' : 'â—¯';
        statusTag.title = page.status ? 'å·²å®Œæˆ (ç‚¹å‡»åˆ‡æ¢)' : 'æœªå®Œæˆ (ç‚¹å‡»åˆ‡æ¢)';
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ¥åˆ‡æ¢çŠ¶æ€
        statusTag.addEventListener('click', async (event) => {
            event.stopPropagation();
            
            try {
                // è·å–æ–‡ä»¶å†…å®¹
                const filePath = page.file.path;
                const fileContent = await app.vault.adapter.read(filePath);
                
                // æ›´æ–°çŠ¶æ€å€¼
                const newStatus = !page.status;
                
                // å‡†å¤‡æ›¿æ¢çš„å†…å®¹
                let newContent;
                
                if (fileContent.startsWith('---')) {
                    const yamlEndIndex = fileContent.indexOf('---', 3);
                    if (yamlEndIndex > 0) {
                        const yamlContent = fileContent.substring(0, yamlEndIndex);
                        
                        if (yamlContent.includes('status:')) {
                            newContent = fileContent.replace(
                                /status:\s*(true|false)/i,
                                `status: ${newStatus}`
                            );
                        } else {
                            newContent = fileContent.replace(
                                '---',
                                `status: ${newStatus}\n---`
                            );
                        }
                    } else {
                        newContent = `---\nstatus: ${newStatus}\n---\n\n${fileContent}`;
                    }
                } else {
                    newContent = `---\nstatus: ${newStatus}\n---\n\n${fileContent}`;
                }
                
                // å†™å…¥æ–‡ä»¶
                await app.vault.adapter.write(filePath, newContent);
                
                // æ›´æ–°UI
                statusTag.textContent = newStatus ? 'âœ“' : 'â—¯';
                statusTag.title = newStatus ? 'å·²å®Œæˆ (ç‚¹å‡»åˆ‡æ¢)' : 'æœªå®Œæˆ (ç‚¹å‡»åˆ‡æ¢)';
                
                // æ›´æ–°é¡µé¢å¯¹è±¡çš„çŠ¶æ€
                page.status = newStatus;
                
                // å¦‚æœå½“å‰æœ‰çŠ¶æ€ç­›é€‰ï¼Œå¯èƒ½éœ€è¦é‡æ–°æ¸²æŸ“
                if (filters.status !== 'all') {
                    renderGallery();
                }
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                const notification = document.createElement('div');
                notification.textContent = `å·²å°† "${page.title}" æ ‡è®°ä¸º${newStatus ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}`;
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.right = '20px';
                notification.style.padding = '10px 15px';
                notification.style.backgroundColor = '#4CAF50';
                notification.style.color = 'white';
                notification.style.borderRadius = '4px';
                notification.style.zIndex = '1000';
                notification.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                document.body.appendChild(notification);
                
                // 2ç§’åç§»é™¤æç¤º
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 2000);
                
            } catch (error) {
                console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                const errorNotification = document.createElement('div');
                errorNotification.textContent = `æ›´æ–°çŠ¶æ€å¤±è´¥: ${error.message}`;
                errorNotification.style.position = 'fixed';
                errorNotification.style.bottom = '20px';
                errorNotification.style.right = '20px';
                errorNotification.style.padding = '10px 15px';
                errorNotification.style.backgroundColor = '#F44336';
                errorNotification.style.color = 'white';
                errorNotification.style.borderRadius = '4px';
                errorNotification.style.zIndex = '1000';
                document.body.appendChild(errorNotification);
                
                setTimeout(() => {
                    document.body.removeChild(errorNotification);
                }, 3000);
            }
        });
        
        imgContainer.appendChild(statusTag);
        card.appendChild(imgContainer);
        
        // ä¿¡æ¯åŒºåŸŸ
        const infoDiv = document.createElement('div');
        infoDiv.className = 'media-info';
        
        // æ ‡é¢˜é“¾æ¥
        const title = document.createElement('a');
        title.className = 'media-title';
        title.href = page.file.path;
        title.dataset.href = page.file.path;
        title.textContent = typeof page.title === 'object' ? 
            (page.title.toString ? page.title.toString() : 'æœªå‘½å') : 
            (page.title || 'æœªå‘½å');
        title.addEventListener('click', (event) => {
            event.preventDefault();
            if (app && app.workspace) {
                app.workspace.openLinkText(page.file.path, '', false);
            }
        });
        infoDiv.appendChild(title);
        
        // æ·»åŠ åˆ›ä½œè€…ä¿¡æ¯ï¼ˆå¯¼æ¼”ã€ä½œè€…ã€æ¼”å‘˜ç­‰ï¼‰
        try {
            if (page.type === 'movie' && page.director) {
                const creator = document.createElement('div');
                creator.className = 'media-creator';
                creator.textContent = `å¯¼æ¼”: ${typeof page.director === 'object' ? 
                    (page.director.toString ? page.director.toString() : 'æœªçŸ¥') : page.director}`;
                infoDiv.appendChild(creator);
            } else if ((page.type === 'movie' || page.type === 'teleplay') && page.actor) {
                const creator = document.createElement('div');
                creator.className = 'media-creator';
                creator.textContent = `ä¸»æ¼”: ${typeof page.actor === 'object' ? 
                    (page.actor.toString ? page.actor.toString() : 'æœªçŸ¥') : page.actor}`;
                infoDiv.appendChild(creator);
            } else if (page.type === 'book' && page.author) {
                const creator = document.createElement('div');
                creator.className = 'media-creator';
                creator.textContent = `ä½œè€…: ${typeof page.author === 'object' ? 
                    (page.author.toString ? page.author.toString() : 'æœªçŸ¥') : page.author}`;
                infoDiv.appendChild(creator);
            } else if (page.type === 'game' && page.developer) {
                const creator = document.createElement('div');
                creator.className = 'media-creator';
                creator.textContent = `å¼€å‘å•†: ${typeof page.developer === 'object' ? 
                    (page.developer.toString ? page.developer.toString() : 'æœªçŸ¥') : page.developer}`;
                infoDiv.appendChild(creator);
            }
        } catch (e) {
            console.error('åˆ›ä½œè€…ä¿¡æ¯å¤„ç†é”™è¯¯:', e);
        }
        
        // æ·»åŠ å‘è¡Œæ—¥æœŸä¿¡æ¯ï¼ˆç²¾ç¡®åˆ°æœˆä»½ï¼‰
        try {
            if (page.datePublished || page.releaseDate) {
                const date = document.createElement('div');
                date.className = 'media-date';
                
                // ä½¿ç”¨releaseDateä½œä¸ºå¤‡é€‰
                let dateValue = page.datePublished || page.releaseDate;
                let dateText = dateValue.toString();
                
                // æ ¼å¼åŒ–æ—¥æœŸï¼Œç²¾ç¡®åˆ°æœˆä»½
                if (dateText.includes('-')) {
                    const parts = dateText.split('-');
                    if (parts.length >= 2) {
                        dateText = parts[0] + 'å¹´' + parts[1] + 'æœˆ';
                    }
                } else if (!isNaN(dateText)) {
                    dateText = dateText + 'å¹´';
                }
                
                date.textContent = dateText;
                infoDiv.appendChild(date);
            }
        } catch (e) {
            console.error('æ—¥æœŸå¤„ç†é”™è¯¯:', e);
        }
        
        // æ·»åŠ é¢å¤–ä¿¡æ¯ï¼ˆä¹¦ç±é¡µæ•°ã€ç”µå½±æ—¶é•¿ç­‰ï¼‰
        try {
            if (page.type === 'book' && page.pages) {
                const extraInfo = document.createElement('div');
                extraInfo.className = 'media-extra-info';
                extraInfo.textContent = `${page.pages}é¡µ`;
                infoDiv.appendChild(extraInfo);
            } else if (page.type === 'movie' && page.time) {
                const extraInfo = document.createElement('div');
                extraInfo.className = 'media-extra-info';
                extraInfo.textContent = `${page.time}åˆ†é’Ÿ`;
                infoDiv.appendChild(extraInfo);
            } else if (page.type === 'teleplay' && page.episode) {
                const extraInfo = document.createElement('div');
                extraInfo.className = 'media-extra-info';
                extraInfo.textContent = `${page.episode}é›†`;
                infoDiv.appendChild(extraInfo);
            } else if (page.type === 'game' && (page.platform || page.playTime)) {
                if (page.platform) {
                    const platformInfo = document.createElement('div');
                    platformInfo.className = 'media-extra-info';
                    platformInfo.textContent = `å¹³å°: ${page.platform}`;
                    infoDiv.appendChild(platformInfo);
                }
                if (page.playTime) {
                    const timeInfo = document.createElement('div');
                    timeInfo.className = 'media-extra-info';
                    timeInfo.textContent = `æ¸¸æˆæ—¶é•¿: ${page.playTime}`;
                    infoDiv.appendChild(timeInfo);
                }
            }
        } catch (e) {
            console.error('é¢å¤–ä¿¡æ¯å¤„ç†é”™è¯¯:', e);
        }
        
        card.appendChild(infoDiv);
        gallery.appendChild(card);
    });
    
    if (filteredPages.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = 'æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç»“æœ';
        container.appendChild(noResults);
    }
}

// æ’åºé¡µé¢ - ä¿®å¤æ’åºå‡½æ•°
function sortPages(pages) {
    // è½¬æ¢ä¸ºæ•°ç»„ä»¥ä¾¿æ’åº
    const pagesArray = [...pages];
    
    return pagesArray.sort((a, b) => {
        let valueA, valueB;
        
        // æ ¹æ®æ’åºå­—æ®µè·å–å€¼
        if (sortState.field === 'score') {
            valueA = typeof a.score === 'number' ? a.score : parseFloat(a.score || 0);
            valueB = typeof b.score === 'number' ? b.score : parseFloat(b.score || 0);
        } 
        else if (sortState.field === 'title') {
            valueA = (a.title || '').toString().toLowerCase();
            valueB = (b.title || '').toString().toLowerCase();
        }
        else if (sortState.field === 'datePublished') {
            // å¤„ç†æ—¥æœŸå‘å¸ƒ
            valueA = a.datePublished ? new Date(a.datePublished) : new Date(0);
            valueB = b.datePublished ? new Date(b.datePublished) : new Date(0);
            
            // å¦‚æœæ—¥æœŸæ— æ•ˆï¼Œå°è¯•ä½œä¸ºå¹´ä»½å¤„ç†
            if (isNaN(valueA.getTime()) && !isNaN(parseInt(a.datePublished))) {
                valueA = parseInt(a.datePublished);
            }
            if (isNaN(valueB.getTime()) && !isNaN(parseInt(b.datePublished))) {
                valueB = parseInt(b.datePublished);
            }
            
            // å¦‚æœä»ç„¶æ— æ•ˆï¼Œæ”¾åˆ°æœ€å
            if (isNaN(valueA.getTime()) && typeof valueA !== 'number') valueA = 0;
            if (isNaN(valueB.getTime()) && typeof valueB !== 'number') valueB = 0;
        }
        else if (sortState.field === 'ctime') {
            valueA = a.file && a.file.ctime ? new Date(a.file.ctime) : new Date(0);
            valueB = b.file && b.file.ctime ? new Date(b.file.ctime) : new Date(0);
        }
        
        // æ ¹æ®æ’åºæ–¹å‘æ¯”è¾ƒ
        if (sortState.direction === 'asc') {
            if (valueA < valueB) return -1;
            if (valueA > valueB) return 1;
            return 0;
        } else {
            if (valueA > valueB) return -1;
            if (valueA < valueB) return 1;
            return 0;
        }
    });
}

// åˆå§‹åŒ–å‡½æ•°
function init() {
    createFilterButtons();
    renderGallery();
}

// æ‰§è¡Œåˆå§‹åŒ–
init();