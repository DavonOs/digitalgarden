---
{"dg-publish":true,"dg-permalink":"books/35799208/01","permalink":"/books/35799208/01/","metatags":{"description":"xlwings 创始人教你如何让 Excel 飞起来！* 告别烦琐公式和 VBA 代码* 办公人士零压力学 Python* 流行 Python 库 xlwings 创始人亲授每当花上几小时手动更新 Excel 工作簿时，或者每当 Excel 工作簿因保存了太多数据而崩溃时，你都应该停下来，思考自己是否应该换个工作方式。本书将展示为什么在 Excel 中引入 Python 是明智之举——你将能够轻松突破 Excel 的瓶颈，避免人为错误，把更多宝贵的时间花在能产生更大价值的任务上。在微软运营的在线用户反馈论坛上，大量用户提出希望“将 Python 作为 Excel 的脚本语言”。相比 Excel 现有的 VBA 语言，Python 究竟有何优势，又该如何发挥这些优势？开源 Python 库 xlwings 的诞生很好地回答了这些问题，它让 Excel 和 Python 珠联璧合。作为 xlwings 的创始人，本书作者将展示如何借用 Python 的力量，让 Excel 快得飞起来！xlwings 帮助 Excel 用户利用 Python 脚本将任务自动化，从而实现效率飞跃。费利克斯在工作中接触了大量 Excel 用户，这使他对 Excel 在各行各业中的使用瓶颈和解决思路拥有深刻的见解。","og:site_name":"DavonOs","og:title":"Excel Python","og:type":"book","og:url":"https://zuji.eu.org/books/35799208/01","og:image":"https://file.ituring.com.cn/LargeCover/22038dc37469788a2ed5","og:image:width":"50","og:image:alt":"bookcover"},"created":"2025-09-24 13:26","updated":"2025-09-26 15:25"}
---


## 1.1 Excel 作为一门编程语言

本节首先会介绍 Excel 是如何被当作编程语言的，让你明白为什么工作表出问题经常上新闻。然后，我们会看看在软件开发社区中兴起的一些最佳实践，这些最佳实践可以让你规避很多典型的 Excel 错误。最后，我们会简单了解 Power Query 和 Power Pivot 这两种现代 Excel 工具，它们涵盖了我们之后会用 pandas 来实现的各种功能。

如果用 Excel 做过比购物清单更复杂的表格，那么你肯定用过像 $=SUM (A1: A4)$ 这样的对单元格求和的函数。如果花几秒思考一下它的工作原理，你就会发现一个单元格的值通常依赖于一个或多个其他单元格。也就是说，这些被依赖的单元格可能又会在它依赖的其他单元格上再次调用这个函数。这种函数的嵌套调用和其他编程语言的工作方式并无二致，只不过你是在表格中写代码，而不是写在一个文本文件中。如果你还是不相信 Excel 是一门编程语言，那就继续往下看。在 2020 年年末，微软宣布会在 Excel 中引入 lambda 函数，让你可以用 Excel 自己的公式语言来编写可重用的函数，也就是说不一定要使用 VBA 之类的其他语言来实现这种效果。据 Excel 产品部门的负责人 Brian Jones 所说，这是让 Excel 成为一门“真正的”编程语言的点睛之笔。这也就意味着 Excel 用户可以被称作 Excel 程序员了！

不过 Excel 程序员和一般的程序员有点儿不一样，他们大部分是商业用户或领域专家，并没有接受过与计算机科学相关的正式教育。举例来说，他们可能是交易员、会计、工程师，等等。他们的工作表工具都是用来解决业务问题的，并且一般不会注意软件开发上的最佳实践。因此，他们的工作表工具往往会把输入、运算和输出全部混在一起，可能需要进行一些很麻烦的操作才能让工作表正常工作。这个过程涉及的很多关键性改动也毫无安全保障可言。这些软件往往缺少稳固的应用程序架构，并且通常没有文档说明，也没经过测试。有时候这些问题可能会造成灾难性的后果，如果你在交易前忘了重新计算你的交易工作簿，则可能会导致对股份进行了错误的交易——你可能就亏了。如果你不是用自己的钱在交易，那么可能就会像下文中所说的那样，你会上新闻。

### 1.1.1 新闻中的 Excel

Excel 是新闻报道中的常客，在我撰写本书期间就有两则相关新闻冲上头条。第一则和 HUGO 基因命名委员会（HUGO Gene Nomenclature Committee）有关。为了让 Excel 不再将一部分人类基因解释为日期，这个委员会对它们进行了重命名。例如，为了让 Excel 不把 MARCH 1 基因当作 1- Mar（3 月 1 日），委员会把它改成了 MARCHF 1²。第二则新闻发生在英国，人们认为是 Excel 导致了 16000 名患者没有被及时报告。出现问题的原因是检验结果以旧式 Excel 文件格式（. xls）保存，而这种格式最多只能保存大概 65000 行数据。这就意味着超出限制的那部分数据会被直接砍掉。这两则新闻体现了 Excel 在当今世界的重要性及其在表格软件中的优势地位，但最有名的“Excel 事故”可能非“伦敦鲸”（London Whale）莫属。

“伦敦鲸”是一位交易员的外号，他在交易时犯下的错误使得摩根大通公司在 2012 年蒙受高达 60 亿美元的损失。这一重大失误的根源在于，一个用 Excel 实现的风险价值模型严重低估了其中一个投资组合的实际亏损风险。《摩根大通公司管理工作组关于 2012 年 CIO 损失的报告》（Report of JPMorgan Chase & Co. Management Task Force Regarding 2012 CIO Losses³，2013）提到：“这个模型需要不断把数据从一张工作表复制并粘贴到另一张工作表中来运作，并且必须手动完成。”除了操作上的问题，他还在运算中犯了一个逻辑错误：他除以了总和，而不是平均数。

如果你还想看这类故事，可以访问由欧洲工作表风险兴趣小组（European Spreadsheet Risks Interest Group，EuSpRIG）维护的 Horror Stories 网站。

为了不让你的公司也因为类似的事情上新闻，我们接下来了解一些最佳实践。这些原则可以让你更安全地使用 Excel。

### 1.1.2 编程最佳实践

本节会介绍最重要的编程最佳实践，涉及关注点分离、DRY 原则、测试和版本控制。我们会看到，坚守这些最佳实践可以让 Python 和 Excel 用起来更流畅。

#### 关注点分离

编程最重要的设计原则之一就是关注点分离（separationofconcerns），有时候也称作模块化（modularity）。意思就是说，一系列相关的功能应当被视作程序中一个独立的部分来处理，从而可以在不影响应用程序其他部分的情况下，轻松地替换这一部分。笼统地讲，一个应用程序通常被分为如下 3 层。

表示层（presentationlayer）
业务层（businesslayer）
数据层（datalayer）

为了便于解释，想一想图 1-1 所示的简单汇率转换器，对应的 `currency_converter.xlsx` 文件在配套代码库的 xl 文件夹中。

![](https://cdn-mineru.openxlab.org.cn/result/2025-09-15/dd9a4891-4e25-48b7-8140-6cdacb8609b4/5b64dbc91692c9ab1bdc31b402b6ec08fde532bf903a446d0b9a137e5769ee13.jpg)  
图 1-1：currency_converter. xlsx

这个应用程序的工作原理是这样的：在 A 4 和 B 4 中分别输入 Amount（金额）和 Currency（货币），Excel 会在 D 4 中把输入的金额转换为对应的美元金额。很多工作表应用程序是这样设计的，并且每天都会用到业务中。下面来把它划分成 3 层。

表示层

这一层是你可以看到并与之交互的部分，也就是所谓的用户界面。A4 单元格、B4 单元格和 D4 单元格及它们的标签构成了这个汇率转换器的表示层。

业务层

这一层负责特定应用程序的逻辑。D4 单元格定义了金额如何被转换成美元金额。公式`=A4 * VLOOKUP(B4, F4:G11, 2, FALSE)`的意思就是让金额乘以汇率。

数据层

顾名思义，这一层负责访问数据。D4 单元格的 VLOOKUP 部分负责完成这项工作。

数据层会访问从 F 3 开始的汇率表数据，这一块单元格就像是这个应用程序的数据库一样。如果观察得够仔细，你就会发现每一层都有 D 4。这样一个简单的应用程序把表示层、业务层和数据层全部混在了一个单元格中。

对于这样一个简单的汇率转换器来说，这可能不是什么问题。不过很多时候一个 Excel 文件一开始很小，但很快就会变得越来越大。如何解决这种问题呢？大部分专业 Excel 开发者会建议你为每一层（用 Excel 的话来说，应该叫输入层、计算层和输出层）单独分配一张工作表。同时还可以为每一层指定一种对应的颜色，比如为所有的输入层单元格设置蓝色的背景色。在第 11 章中，我们会依照这种层次来构建一个真实的应用程序：用 Excel 作为表示层，而将业务层和数据层都迁移到 Python 中。在 Python 中，组织代码会更容易。

既然明白了什么叫关注点分离，那么接下来了解一下什么是 DRY 原则。

#### DRY 原则

不要自我重复（Don't Repeat Yourself）—— [[程序员修炼之道\|程序员修炼之道]]

没有重复的代码意味着代码行数更少，错误也更少，代码自然也就更容易维护。如果你的业务逻辑位于单元格公式中，那么就难以遵守 DRY 原则，因为没有一种机制可以让你在其他工作簿中重用这些公式。不幸的是，这就意味着每当要启动一个新的 Excel 项目时，最常见的做法就是从一个之前的项目或者模板中把这些含有公式的工作簿复制过来。

如果你会写 VBA，那么函数是重用代码的最常用的方法。函数可以让你在各处都能访问到同一个代码块，比如用各种宏调用函数。如果你有几个很常用的函数，你可能会想让它们能够被多个工作簿共享。要达成这样的目的，标准做法是依靠插件，但是 VBA 插件并没有稳健的分发方式和更新方式。为了解决这一问题，微软引入了 Excel 内部插件商店。但这只适用于用 JavaScript 编写的插件，所以对 VBA 程序员来说并没有用。这就意味着我们在写 VBA 代码时还是要频繁地复制粘贴。

假设我们需要在 Excel 中用到三次样条函数 (cubic spline function)，它可以在坐标系中基于几个给定的点插值成一条曲线。固定收益交易员经常用这种函数，他们通过一些已知的到期日/利率比组合来得到所有到期日的利率曲线。如果你在网上搜索“三次样条 Excel”，很快就能找到你想要的 VBA 代码。但问题在于，写这些代码的人初衷可能是好的，但代码并没有附带文档，也没有经过测试。这些代码可能对于大多数的输入能正常工作，但对于一些不常见的边界条件效果又如何呢？如果要交易上百万的固定收益投资组合，那么你肯定想用一些可靠的东西。当内部审核员发现代码的来源时，至少要让他们也觉得这些代码是可靠的。

我们会在 1.2.2 节中看到，利用包管理器，Python 可以很方便地分发代码。不过在那之前，先来学习测试，它是稳定软件开发大厦的一块基石。

#### 测试

如果你让 Excel 开发者测试一下他们的工作簿，他们很可能只是随随便便点几下，看看宏有没有正常工作，改几个输入看看输出结果是否正常。然而，这是一种极具风险的做法，因为 Excel 很容易出现一些难以察觉的问题。例如，你可能用“写死”的值覆盖了公式，也可能忘了调整隐藏列中的公式。

而如果你让专业软件开发人员测试他们的代码，他们会写单元测试（unit test）。顾名思义，这是一种可以测试程序各个组件的机制。举例来说，单元测试会确保程序中的每一个函数都正常工作。大部分编程语言会提供一种自动执行单元测试的方法。执行自动测试可以使你的代码库的可靠性大幅提升，并且在一定程度上，测试会确保你在编辑代码时不会破坏当前正常工作的代码。

回顾一下图 1- 1 中的汇率转换工具，可以输入下面的数据进行测试：以 100 EUR（欧元）作为金额，1.05 作为 EURUSD（欧元/美元）汇率，检查 D 4 单元格是否正确返回 105 美元。这个测试的用处在哪儿呢？假设你不小心删掉了 D 4 单元格中的公式，不得不重写一遍，但是把“金额乘以汇率”写成了“除以汇率”——毕竟货币运算总是让人晕头转向。现在再来进行上面提到的测试，你会发现测试失败了，因为 100 欧元/1.05 并不会得到测试所期望的 105 美元。经过这样的测试，在把工作表交给用户之前，你就可以检测和修复公式中的错误。

大多数传统编程语言提供了一种甚至多种轻松编写单元测试的框架，但是 Excel 并未提供。好在单元测试的概念本身很简单，而我们还可以把 Python 强大的单元测试框架用到 Excel 上。对单元测试的深入讲解已经超出了本书的范围，不过你可以看一看我的这篇博客文章（"Unit Tests for Microsoft Excel"），在文章中我会通过实际的例子向你介绍相关知识。

通常程序员会对单元测试进行配置，每当代码被提交到版本控制系统的时候，它就会自动运行。接下来我们会介绍什么是版本控制系统，以及为什么很难将其运用到 Excel 文件上。

#### 版本控制

专业程序员还有一个特点就是会使用版本控制（version control）系统，或者称为源代码控制（source control）系统。版本控制系统（version control system，VCS）会不断跟踪源代码的更改，让你能够看到是谁进行了更改，更改了什么，什么时候更改的，为什么更改，并且在任何时候都能还原到过去的版本。当今最受欢迎的版本控制系统是 Git。它原本是为管理 Linux 源代码而生的，但此后整个编程世界都为之征服，甚至微软都在 2017 年采用 Git 来管理 Windows 的源代码。然而在 Excel 的世界里，迄今为止最受欢迎的版本控制系统是像下面这样，即把各个版本的文件堆在文件夹中：

currency_converter_v 1. xlsx
currency_converter_v 2_2020_04_21. xlsx
currency_converter_final_edits_Bob. xlsx
currency_converter_final_final. xlsx

如果不想变成上面这样，那么 Excel 开发者就必须坚守某种命名规则——当然这本身没什么问题。但是，把文件的版本迭代记录保存在本地并不能让你享受到源代码控制的好处，也就是无法顺畅地进行合作、同行评审、推进进度和审查日志。如果你想让工作簿更加安全和稳定，就不能忽略这些流程。通常专业程序员都会结合像 GitHub、GitLab、Bitbucket 和 Azure DevOps 这样的 Web 平台来使用 Git，这些平台可以让你提出所谓的拉取请求（pull request）和合并请求（merge request）。这些操作可以让开发者正式地请求负责人将他们的更改合并到主数据库中。一次拉取请求会提供如下信息：
- 更改的作者；
- 更改发生的时间；
- 在提交信息（commitmessage）中描述的更改目的；
- 在 diff 视图（其中新代码以绿色高亮显示，删掉的代码以红色高亮显示）中展示的更改细节。

这样其同事或者团队领导就可以审核更改并发现问题。一般只要多一个人检查就会多发现一两个问题，也可能会给程序员宝贵的反馈。既然有这么多好处，那为什么 Excel 开发者还是喜欢用本地文件系统和命名规则来进行版本控制，而不用专业的 Git 呢？

- 很多 Excel 用户要么完全不知道 Git，要么是因为 Git 相对陡峭的学习曲线入门即放弃。
- Git 允许多名用户并行地操作同一个文件的本地副本。在这些用户都提交了工作成果之后，Git 通常会自动合并所有更改且无须手动干预。但这对 Excel 文件不起作用：如果这些文件是通过多个副本并行更改的，那么 Git 并不知道如何将这些更改合并到一个文件中。
- 即便处理好了上述问题，Git 也无法像在处理文本文件时那样好用，因为 Git 无法体现出 Excel 文件的更改细节，这就使得人们无法进行同行评审。

考虑到上述问题，我的公司选择了 xltrail。xltrail 也是一个基于 Git 的版本控制系统，但它知道怎么处理 Excel 文件。xltrail 隐藏了 Git 的复杂性，使得商业用户用起来更舒服，并且在你想用 GitHub 之类的平台来跟踪文件时，它也可以连接到外部 Git 系统。xltrail 会跟踪工作簿的各个不同的组件（涵盖单元格公式、名称范围、PowerQuery 和 VBA 代码)，让你能够利用版本控制的突出优势，这其中就包括同行评审。

要想轻松对 Excel 进行版本控制，还有一个选项就是将业务逻辑迁移到 Python 中来，第 10 章会对此进行介绍。用 Git 来跟踪 Python 文件很轻松，因而你用 Python 编写的工作表工具管理起来也会很轻松。

虽然本节叫“编程最佳实践”，但我主要是想解释，和 Python 一类的传统编程语言相比，为什么在 Excel 中进行这些实践很难。在把注意力投向 Python 之前，我想先简单介绍一下微软对 Excel 现代化做出的尝试：Power Query 和 Power Pivot。

### 1.1.3 现代 Excel

Excel 的“现代”始于 Excel 2007，在这一版本中引入了功能区菜单和新的文件格式（xls 之后的 xlsx）。然而 Excel 社区一般用“现代 Excel”来指代在 Excel 2010 中新增的工具，其中最重要的就是 Power Query 和 Power Pivot。它们让你可以连接到外部数据源，分析那些一张工作表装不下的数据。由于它们的功能和第 5 章将介绍的 pandas 有重合的部分，因此本节第一部分会先对它们进行简要介绍。第二部分会讲到 Power BI，可以将其视作一个将 Power Query 和 Power Pivot 相结合的独立的商业智能应用程序，并且它还带有可视化功能以及内置的 Python 支持！

#### 1. Power Query 和 Power Pivot

微软在 Excel 2010 中引入了一个叫作 Power Query 的插件。Power Query 可以连接各种数据源，包括 Excel 工作簿、CSV 文件、SQL 数据库，等等。也可以连接像 Salesforce 这样的平台，或是通过扩展连接上面没有提到的数据源。Power Query 的核心功能是处理一张工作表装不下的数据集。在加载数据之后，你还可以通过额外的操作来清理、操作数据，使之成为 Excel 可用的形式。例如，可以把一列分成两列、合并两张表、对数据进行过滤和分组，等等。自 Excel 2016 起，Power Query 就不再是一个插件，而是可以通过功能区标签页上的“获取数据”按钮直接访问。Power Query 在 macOS 中只支持一部分功能，但是目前仍在积极开发中，在今后的版本中应该可以得到完全支持。

Power Pivot 和 Power Query 联系密切，从概念上来讲，在利用 Power Query 获取和清理数据之后，就该 Power Pivot 上场了。Power Pivot 帮助你以一种引人入胜的方式直接在 Excel 中分析和呈现数据。你可以把它视作一种传统意义上的数据透视表。和 Power Query 一样，它也可以处理大型数据集。Power Pivot 让你可以用关系和层次来定义形式上的数据模型，并且可以通过 DAX 公式语言添加计算列。Power Pivot 也是在 Excel 2010 中引入的，但目前它仍然以插件形式存在，尚未支持 macOS。

如果你喜欢使用 Power Query 和 Power Pivot，并且想在其上构建仪表板，那么还应该看看 Power BI。现在来看看原因。

#### 2. Power BI

Power BI 是在 2015 年发布的一个独立应用程序。它是微软针对 Tableau 和 Qlik 这类工具做出的反击。Power BI Desktop 是免费的，可以从 Power BI 主页下载。但是要注意，Power BI Desktop 只支持 Windows。Power BI 希望通过在交互式仪表板中可视化巨大的数

据集使其更容易理解。和 Excel 一样，它的核心功能页依赖于 Power Query 和 Power Pivot。Power BI 的商业版可以让你在线和他人合作，并共享仪表板。普通的桌面版中不带有这些功能。对本书所涉及的内容来说，Power BI 令人激动的原因在于它自 2018 年起就支持 Python 脚本了。通过 Python 图表库，Python 既可用于数据查询部分，也可用于可视化部分。对我来说，在 Power BI 中使用 Python 感觉有点儿别扭，但重要的是这体现了微软已经意识到 Python 对于数据分析的重要性。相应地，人们对于 Excel 获得官方 Python 支持的希望也日渐高涨。

那么 Python 有什么了不起的地方使微软选择让 Power BI 来支持它呢？下一节会给出一些答案。

## 1.2 用在 Excel 上的 Python

Excel 的主要功能是存储数据、分析数据和可视化数据。而 Python 在科学计算方面也极其强大，天生就适合搭配 Excel 工作。能同时引起专业程序员和初学者（他们可能几周只写那么几行代码）兴趣的编程语言不多，Python 便是其中一门。专业程序员喜欢 Python 是因为它是一门通用编程语言。你可以用 Python 轻松地实现大部分事情。而对于初学者来说，比起其他语言，Python 显得更加简单易学。Python 的用途广泛，小到即时数据分析、自动化任务，大到如 Instagram 后端的代码库，都有 Python 的功劳。这也就意味着当你用 Python 编写的 Excel 工具流行起来之后，可以很容易地找到一名 Web 开发人员将你的 Excel- Python 原型转化为功能齐全的 Web 应用程序。Python 的独特优势在于，处理业务逻辑的部分很可能不需要重写就能原封不动地从 Excel 原型迁移到 Web 生产环境中。

本节会介绍 Python 的各种核心概念，并会将它们和 Excel 及 VBA 进行对比，也会涉及可读性、Python 标准库、包管理器、科学计算栈、现代语言特性、跨平台兼容性等内容。先来了解一下可读性。

### 1.2.1 可读性和可维护性

当说代码“可读”时，意思是这些代码很容易理解——特别是对于那些并没有写这些代码的人来说。良好的可读性使得发现错误和维护代码更加容易，这也是为什么 Python 之禅（The Zen of Python）中会写道“可读性很重要”（readability counts）。Python 之禅是对 Python 核心设计原则的精辟总结，在第 2 章中我们会学到如何输出这首禅诗。先来看看下面的 VBA 代码：

```
If i < 5 Then  Debug.Print "i is smaller than 5"  ElseIf i <= 10 Then  Debug.Print "i is between 5 and 10"  Else  Debug.Print "i is bigger than 10"  End If
```

在 VBA 中，可以将上面的代码整理成下面这样，前后两段代码完全等效：

```
If i < 5 Then    Debug.Print "i is smaller than 5"    ElseIf i <= 10 Then    Debug.Print "i is between 5 and 10"    Else    Debug.Print "i is bigger than 10"End If
```

在第一个版本中，视觉上的缩进和代码逻辑一致。这使得代码易于阅读和理解，进而更容易发现其中的错误。在第二个版本中，初见这段代码的开发者可能看不到 ElseIf 和 Else 条件，而如果这段代码来自更为庞大的代码库则更是如此。

Python 不会接受像上面第二个版本那样的代码，它会强制你将视觉缩进和代码逻辑对齐，从而避免可读性问题。之所以有这种强制性，是因为当你在 if 语句或 for 循环中使用代码块时，Python 依靠缩进来定义代码块。其他大多数语言用花括号而不是缩进来定义代码块，VBA 则使用 End If 等关键字，就像我们刚才在前面的代码中看到的那样。使用缩进定义代码块的原因在于，编程时大部分时间是花费在维护代码而不是现写新的代码上。可读性好的代码可以帮助新进程序员（也可能是写下代码几个月之后的你自己）回顾过去、了解现状。

第 3 章会介绍 Python 的缩进规则，现在先来了解一下 Python 提供的随时可用的内置功能——标准库。

### 1.2.2 标准库和包管理器

Python 通过标准库提供了丰富的内置工具。Python 社群喜欢称之为“自带电池”。无论是需要解压 ZIP 文件，还是从 CSV 文件中读取数据，抑或想要从互联网上获取数据，Python 标准库都能给你安排妥当，并且通常只需要几行代码。如果想在 VBA 中实现同样的功能，则可能需要大量的代码，或是安装插件。通常你在网上找到的解决方案都只能在 Windows 中工作，到 macOS 中就不行了。

尽管 Python 标准库涵盖了大量的功能，但还是有一些功能难以编写，又或是使用标准库来实现效率很低。这个时候就该 PyPI 上场了。PyPI 代表 Python Package Index（Python 包目录），它是任何人（包括你！）都可以上传开源 Python 包的巨大仓库，利用这些包可以扩展 Python 的功能。

#### PyPI 和 PyPy

PyPI 读作“pie pea eye”，PyPy 则读作“pie pie”。PyPy 是另一种高效的 Python 实现。

如果你想更方便地从互联网上获取数据，就可以安装 Requests 包来获取一系列强大又好用的命令。要安装一个包，你需要在命令提示符或者终端中使用 Python 的包管理器，即 pip。pip 是 pip installs packages 的递归缩写。虽然听起来有点儿抽象，不过别担心，第 2 章会解释它是如何工作的。现在更重要的是理解为什么包管理器如此重要。一个主要原因是，任何优质的包可能不仅依赖于 Python 标准库，还会依赖于 PyPI 上的其他开源包。而这些依赖项又可能会依赖其他的包，层层递进。pip 会递归地检查一个包的依赖项和子依赖项，并逐一下载安装。你还可以使用 pip 轻松地更新包，以保持各个依赖项都是最新版本。pip 让你能够坚守 DRY 原则，因为不用重新发明轮子或者复制粘贴 PyPI 上已有的包。有了 pip 和 PyPI，你就有了一套统一的机制来分发和安装依赖项——这正是 Excel 的插件所欠缺的。

#### 开源软件

在这里我想简单谈一下开源（open source）。本节在前面内容中已经几次提到这个词。如果一款软件依照某种开源许可证分发，那么就意味着我们可以免费、自由地获取它的源代码，并且任何人都可以参与添加新功能、修复 bug 或撰写文档。Python 本身以及大多数第三方 Python 包是开源的，大部分是由开发者在业余时间维护的。但这并不一定是一种理想状态。如果你的公司长期在用一个包，那么你会希望有专业开发者对其进行持续开发和维护。幸运的是，Python 科学计算社区已经意识到了这一点：一些包对于科学计算至关重要，如果把它们留给只在晚上和周末对其进行开发的少数志愿者，则实在令人不放心。

非营利性组织 NumFOCUS 于 2012 年成立，它的诞生就是为了赞助科学计算领域的一些 Python 包和项目。NumFOCUS 赞助的最受欢迎的项目包括 pandas、NumPy、SciPy、Maplotlib 和 Project Jupyter。如今它也会对其他语言（比如 R、Julia 和 JavaScript）的软件包提供支持。虽然还存在一些大型企业赞助商，但是每个人都可以作为一名自由社区成员加入 NumFOCUS，另外捐献是可以减税的。

可以使用 pip 安装任何功能的包，而对于 Excel 用户来说，最有趣的当然还是用于科学计算的包。下一节会介绍如何通过 Python 进行科学计算。

### 1.2.3 科学计算

Python 成功的关键原因在于，它是作为一门通用编程语言诞生的。它的科学计算能力是在诞生之后通过第三方包的形式增加的。数据科学家可以和 Web 开发者使用同一门语言来做实验和研究，最终 Web 开发者可以围绕数据科学家开发的计算核心开发一个随时可上线的应用程序，这正是 Python 的独特优势。使用一门语言来构建科研应用程序可以减少冲突、减少实现时间，甚至减少花费。诸如 NumPy、SciPy 和 pandas 之类的科学计算库给我们提供了一种简洁的方式来表达数学问题。作为一个例子，来看看现代投资组合理论中比较有名的投资组合方差公式。

$$
\sigma^2 = w^T Cw
$$

令  $\sigma^2$  为投资组合方差，  $w$  为单个资产的权重向量，  $C$  为投资组合方差矩阵。若  $w$  和  $C$  为 Excel 中的范围，则在 VBA 中可以像下面这样计算投资组合方差：

variance  $=$  Application. MMult (Application. MMult (Application. Transpose (w), C), w) 假定  $W$  和  $C$  是 pandas 的 DataFrame 和 NumPy 中的数组，相比之下 Python 代码完全就像是数学记法：

variance= w.T@C @w

但这并非仅仅是美观和可读性方面的优势。NumPy 和 pandas 背后使用了预编译的 Fortran 代码和 C 代码，在处理大型矩阵时和 VBA 相比有巨大的性能提升。

缺少对科学计算的支持是 VBA 明显的短板，但即便是核心语言特性方面，它也显然不敌 Python。在下一节中你会看到这种差距。

### 1.2.4 现代语言特性

自 Excel 97 以来 VBA 在语言特性方面几乎没有任何重大改进，但这并不意味着 VBA 不再受到支持。为了让 VBA 能够自动化 Excel 中的新功能，在每次 Excel 发布新版本时，微软也会对 VBA 进行更新，比如在 Excel 2016 中就添加了自动化 PowerQuery 的支持。作为一门近 20 年没有重大改进的语言，VBA 缺少了一些所有主流语言都有的现代语言概念。举例来说，VBA 中的错误处理看起来就有些过时了。如果想在 VBA 中得当地处理错误，就要这样做：

```
Sub PrintReciprocal(number As Variant) ' There will be an error if the number is 0 or a string On Error GoTo ErrorHandler result  $= 1$  /number On Error GoTo 0 Debug.Print "There was no error!" Finally: 'Runs whether or not an error occurs If result  $=$  ""Then result  $=$  "N/A" End If Debug.Print "The reciprocal is:"& result Exit Sub ErrorHandler: 'Runs only in case of an error Debug.Print "There was an error:"& Err.Description Resume Finally End Sub
```

VBA 的错误处理需要用到像 Finally 和 ErrorHandler 这样的标签，通过 GoTo 和 Resume 语句可以让代码跳转到这些标签。在当时，人们认为标签是产生所谓意大利面式代码（对代码难以阅读和维护的一种打趣的说法）的罪魁祸首。这也就解释了为什么大多数还在积极开发中的语言引入了 try/catch 机制。这种机制在 Python 中叫作 try/except，第 11 章会介绍。如果能熟练使用 VBA，那么你可能也会喜欢 Python 的类继承特性。这种面向对象编程特性正是 VBA 所欠缺的。

除了一些现代语言特性，一门现代编程语言还有一项必备特性，那便是跨平台兼容性。下面来看看为什么跨平台兼容性如此重要。

### 1.2.5 跨平台兼容性

即便在一台运行着 Windows 或者 macOS 的本地计算机上开发，在某个时候你也可能会想让代码在一台服务器或者云端上运行。服务器会通过其运算能力，让代码按计划执行，并使应用程序可以从任何地方访问。在第 2 章中我会介绍 Jupyter 笔记本，展示如何在服务器上执行 Python 代码。Linux 是一种非常稳定、安全且高效的操作系统，绝大多数服务器使用的是 Linux。Python 程序可以在不修改代码的情况下在所有操作系统中运行，你可以轻松地从本地开发机器过渡到生产环境中。

相比之下，即便 Excel VBA 可以在 Windows 和 macOS 中运行，但还是很容易写出一些只能在 Windows 中执行的代码。在 VBA 的官方文档或论坛中，经常会看到这样的代码：

Set fso = CreateObject ("Scripting. FileSystemObject")

只要调用了 CreateObject，或者被要求在 VBA 编辑器的“工具 > 引用”选项中添加引用，你很有可能就是在处理只能在 Windows 系统中运行的代码。如果想让 Excel 文件可在 Windows 和 macOS 中使用，则还需要重点关注是否使用了 ActiveX 控件。ActiveX 控件就是那些可以放在表格上的按钮、下拉菜单之类的控件元素，这些控件只能在 Windows 中使用。如果想让工作簿也能在 macOS 中使用，那么务必避免使用这些控件！

## 1.3 小结

在本章中，我们认识了 Python 和 Excel。和我们今天使用的很多技术相比，它们两位都是“德高望重”了。伦敦鲸的故事作为 Excel 用户的反面教材，它（用损失金额）告诉了我们错误地使用 Excel 能把事情搞到多糟糕。这个故事激发了我们学习编程最佳实践（关注点分离、DRY 原则、充分利用自动测试和版本控制）的动力。随后我们了解了 Power Query 和 Power Pivot，它们是微软提供的处理大型数据集的办法。不过我时常觉得它们并非解决问题的办法，因为它们会把你限制在微软的地盘上，让你无法充分利用现代云端解决方案的灵活性和高性能。

Python 拥有 Excel 所缺少的优势：标准库、包管理器、科学计算库和跨平台兼容性。在学习如何将 Python 和 Excel 相结合之后，你可以取二者之所长，通过自动化节省时间，通过更严格地遵循编程最佳实践来减少提交错误，在需要的时候你也可以将应用程序带出 Excel 并扩大规模。

既然你已经知道为何 Python 可以成为 Excel 的“好伙伴”，那么是时候配置好环境，开始写你的第一行 Python 代码了！